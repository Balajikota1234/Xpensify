<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="settings.css">
    <script src="https://cdn.tailwindcss.com"></script>      
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="icon" type="image/x-icon" href="./Favicon.png">
    <title>Xpensify</title>
</head>
<body>
    <section class="container"><br>
      <h1 class="text-3xl font-bold mb-6">Settings</h1>
      <div class="section">
        <div class="section-title">Data</div>

        <button class="btn btn-export setting-label">
        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M440-320v-326L336-542l-56-58 200-200 200 200-56 58-104-104v326h-80ZM240-160q-33 0-56.5-23.5T160-240v-120h80v120h480v-120h80v120q0 33-23.5 56.5T720-160H240Z"/></svg>Export Data</button>

    <div class="date-filter" id="date-filter">
      <label for="from-date">From:</label>
      <input type="date" id="from-date">
      <label for="to-date">To:</label>
      <input type="date" id="to-date">
      <button class="btn-confirm-export">Confirm Export</button>
    </div>

      <button class="btn btn-clear setting-label"> <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3" class="svg-icon"><path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z" /></svg>Clear All Data</button>
      </div>

      <!-- Clear Data Confirmation Dialog -->
  <div id="clear-confirm-dialog" class="confirm-dialog">
  <div class="dialog-box">
    <p>Are you sure you want to clear all your data?</p>
    <div class="dialog-actions">
      <button id="confirm-clear" class="btn-confirm">Yes, Clear</button>
      <button id="cancel-clear" class="btn-cancel">Cancel</button>
    </div>
  </div>
  </div>

      <div class="section">
        <div class="section-title">About</div>
        <div class="about-box setting-label">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M440-280h80v-240h-80v240Zm40-320q17 0 28.5-11.5T520-640q0-17-11.5-28.5T480-680q-17 0-28.5 11.5T440-640q0 17 11.5 28.5T480-600Zm0 520q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z"/></svg>
          Version: 1.0.1
        </div>
      </div>
    <!-- Custom animated dialog for "no data" -->
    <div id="no-data-dialog" class="no-data-dialog">
    ⚠️ No transactions found for the selected date range.
    </div>
    </section>

    <div id="bottom-nav"></div>

<script>
  // CLEAR ALL DATA
  document.querySelector('.btn-clear').addEventListener('click', () => {
  document.getElementById('clear-confirm-dialog').style.display = 'flex';
});

document.getElementById('cancel-clear').addEventListener('click', () => {
  document.getElementById('clear-confirm-dialog').style.display = 'none';
});

document.getElementById('confirm-clear').addEventListener('click', () => {
  localStorage.removeItem('expenses');
  document.getElementById('clear-confirm-dialog').style.display = 'none';
  location.reload(); // or show a "cleared successfully" message
});

  // EXPORT DATA
  const exportBtn = document.querySelector(".btn-export");
  const dateFilterDiv = document.getElementById("date-filter");
  const confirmExportBtn = document.querySelector(".btn-confirm-export");
  const noDataDialog = document.getElementById("no-data-dialog");

  // Step 1: Show date filters on Export button click
  exportBtn.addEventListener("click", function () {
    dateFilterDiv.style.display = "block";
  });

  // Step 2: Confirm export on new button click
  confirmExportBtn.addEventListener("click", function () {
    const fromDate = document.getElementById("from-date").value;
    const toDate = document.getElementById("to-date").value;

    if (!fromDate || !toDate) {
      showNoDataDialog("Please select both 'from' and 'to' dates.");
      return;
    }

    const expenses = JSON.parse(localStorage.getItem("expenses")) || [];

    const filteredExpenses = expenses.filter(exp => {
      const expenseDate = new Date(exp.date);
      return expenseDate >= new Date(fromDate) && expenseDate <= new Date(toDate);
    });

    if (filteredExpenses.length === 0) {
      showNoDataDialog("⚠️ No transactions found for the selected date range.");
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(18);
    doc.text("Xpensify - Expense Report", 10, 10);

    let y = 30;
    let total = 0;

  filteredExpenses.forEach((expense, i) => {
  doc.setFontSize(12);
  doc.text(`${i + 1}. ${expense.category} - Rs. ${expense.amount}`, 10, y);
  y += 7;
  doc.setFontSize(10);
  doc.text(`Date: ${expense.date}`, 12, y);
  y += 5;

  if (expense.description) {
    doc.text(`Description: ${expense.description}`, 12, y);
    y += 8;
  } else {
    y += 3;
  }

  total += Number(expense.amount);

  if (y > 280) {
    doc.addPage();
    y = 20;
  }
  });

    y += 10;
    doc.setFontSize(14);
    doc.text(`Total: Rs. ${total.toLocaleString()}`, 10, y);

    doc.save(`Xpensify_Report_${fromDate}_to_${toDate}.pdf`);
  });

  // Step 3: Show custom animated dialog
  function showNoDataDialog(message) {
    noDataDialog.textContent = message;
    noDataDialog.style.display = "block";

    setTimeout(() => {
      noDataDialog.style.display = "none";
    }, 3000); // Hide after 3 seconds
  }

  fetch("nav.html")
      .then(response => response.text())
      .then(data=>{

        document.getElementById("bottom-nav").innerHTML= data;

        // Detect current page name
    const currentPage = window.location.pathname.split("/").pop();

    // Get all nav items
    const navItems = document.querySelectorAll(".nav-item");

    navItems.forEach(item => {
      const href = item.getAttribute("href");
      if (href === currentPage) {
        item.classList.add("active");
      } else {
        item.classList.remove("active");
      }
    });

      })
      .catch(error=>console.error("Error loading bottom-nav.",error));

  document.addEventListener("DOMContentLoaded", () => {
  const fromDateInput = document.getElementById("from-date");
  const toDateInput = document.getElementById("to-date");

  // Set today's date
  const today = new Date().toISOString().split("T")[0];

  // Set max for from-date and to-date
  fromDateInput.setAttribute("max", today);
  toDateInput.setAttribute("max", today);

  // When from-date is selected, set min for to-date
  fromDateInput.addEventListener("change", () => {
    const fromValue = fromDateInput.value;
    toDateInput.setAttribute("min", fromValue);
  });

  // Optional: Clear to-date if from-date changes
  fromDateInput.addEventListener("input", () => {
    toDateInput.value = "";
  });
  });
</script>
</body>
</html>