<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <link rel="icon" type="image/x-icon" href="./Favicon.png">
    <title>Xpensify</title>
</head>
<body>

    <div class="modal-overlay" id="deleteModal">
    <div class="modal">
      <h3 class="text-xl font-bold">Delete this Expense?</h3>
      <p>This action cannot be undone.</p>
      <div class="modal-buttons">
        <button class="btn-cancel" onclick="cancelDelete()">Cancel</button>
        <button class="btn-delete" onclick="confirmDelete()">Yes, Delete</button>
      </div>
    </div>
    </div>

    <header class="navbar">
        <h1 class="text-3xl font-bold">Xpensify</h1>
        <a href="expenses.html"><button class="add-btn"><i class="bi bi-plus"></i></button></a>
    </header>

    <div class="month-selector">
        <button id="prevMonth">&lt;</button>
        <span id="currentMonth">Month Year</span>
        <button id="nextMonth">&gt;</button>
    </div>

    <main class="main-container">
        <section class="person total-expense">
            <h2 class="text-2xl font-bold">Total Expenses</h2>
            <div class="amount" id="totalAmount">
                <i class="bi bi-currency-rupee"></i>
            </div>
        </section>

        <section class="person category-breakdown">
            <h2 class="text-2xl font-bold">Category Breakdown</h2><br>
            <div id="categoryBreakdown">
                <p class="empty">No Data Available</p>
            </div>
        </section>

        <section class="recent-expenses">
            <h2 class="text-2xl font-bold">Recent Expenses</h2><br>
            <div id="recentExpenses" class="empty">
                <i class="bi bi-view-list"></i>
                <p>No Expenses Found</p>
                <small>Add some expenses to get started</small>
            </div>
            <button id="viewMoreBtn" style="display:none;" class="view-more-btn">View More</button>
        </section>
    </main>

  <div id="bottom-nav"></div>
  
<script>
  let indexToDelete = null;
  let showingAll = false;
  let cycleOffset = 0; // 0 = current cycle, -1 = previous, +1 = next

  // Get current billing cycle range based on saved billingStartDay and offset
  function getCurrentBillingCycle() {
    const billingDay = parseInt(localStorage.getItem("billingStartDay")) || 1;

    const today = new Date();
    const startThisMonth = new Date(today.getFullYear(), today.getMonth(), billingDay);

    let baseStart, baseEnd;
    if (today >= startThisMonth) {
      baseStart = startThisMonth;
      baseEnd = new Date(startThisMonth);
      baseEnd.setMonth(baseEnd.getMonth() + 1);
    } else {
      baseEnd = startThisMonth;
      baseStart = new Date(startThisMonth);
      baseStart.setMonth(baseStart.getMonth() - 1);
    }

    const cycleStart = new Date(baseStart);
    cycleStart.setMonth(cycleStart.getMonth() + cycleOffset);

    const cycleEnd = new Date(baseEnd);
    cycleEnd.setMonth(cycleEnd.getMonth() + cycleOffset);

    return { cycleStart, cycleEnd };
  }

  function updateMonthDisplay() {
    const { cycleStart, cycleEnd } = getCurrentBillingCycle();
    const options = { day: 'numeric', month: 'short' };

    document.getElementById("currentMonth").textContent =
      `Billing Cycle: ${cycleStart.toLocaleDateString('en-GB', options)} - ${cycleEnd.toLocaleDateString('en-GB', options)}`;
  }

  function loadExpenses() {
    const expenses = JSON.parse(localStorage.getItem("expenses")) || [];
    const { cycleStart, cycleEnd } = getCurrentBillingCycle();

    const filteredExpenses = expenses.filter(e => {
      const d = new Date(e.date);
      return d >= cycleStart && d < cycleEnd;
    });

    const totalAmount = filteredExpenses.reduce((sum, e) => sum + Number(e.amount), 0);
    document.getElementById("totalAmount").innerHTML =
      `<i class="bi bi-currency-rupee"></i> ${totalAmount.toFixed(2)}`;

    const recentContainer = document.getElementById("recentExpenses");
    const viewMoreBtn = document.getElementById("viewMoreBtn");

    if (filteredExpenses.length === 0) {
      recentContainer.classList.add("empty");
      recentContainer.innerHTML = `
        <i class="bi bi-view-list"></i>
        <p>No Expenses Found</p>
        <small>Add some expenses to get started</small>`;
      viewMoreBtn.style.display = "none";
    } else {
      recentContainer.classList.remove("empty");

      const itemsToShow = showingAll
        ? filteredExpenses.slice().reverse()
        : filteredExpenses.slice(-5).reverse();

      recentContainer.innerHTML = itemsToShow.map((e, index) => {
        const eDate = new Date(e.date);
        const now = new Date();
        const isCurrentCycle = eDate >= cycleStart && eDate < cycleEnd;

        return `
        <div class="expense-item">
          <strong>${e.category}</strong>
          <p>${e.description || "No Description"}</p>
          <small>${eDate.toLocaleDateString()}</small>
          <span class="amount">₹${Number(e.amount).toFixed(2)}</span>
          ${isCurrentCycle ? `<button onclick="promptDelete(${index})" class="delete-btn">Delete</button>` : ""}
        </div>`;
      }).join("");

      viewMoreBtn.style.display = filteredExpenses.length > 5 ? "block" : "none";
      viewMoreBtn.textContent = showingAll ? "View Less" : "View More";
    }

    // Category breakdown
    const breakdown = {};
    filteredExpenses.forEach(e => {
      breakdown[e.category] = (breakdown[e.category] || 0) + Number(e.amount);
    });

    const catContainer = document.getElementById("categoryBreakdown");
    if (Object.keys(breakdown).length === 0) {
      catContainer.innerHTML = `<p class="empty">No Data Available</p>`;
    } else {
      catContainer.innerHTML = Object.keys(breakdown).map(cat => `
        <div class="category-summary">
          <strong>${cat}</strong>: ₹${breakdown[cat].toFixed(2)}
        </div>`
      ).join("");
    }
  }

  function promptDelete(index) {
    indexToDelete = index;
    document.getElementById("deleteModal").classList.add("show");
  }

  function cancelDelete() {
    indexToDelete = null;
    document.getElementById("deleteModal").classList.remove("show");
  }

  function confirmDelete() {
    if (indexToDelete === null) return;

    let expenses = JSON.parse(localStorage.getItem("expenses")) || [];
    const { cycleStart, cycleEnd } = getCurrentBillingCycle();

    let filteredExpenses = expenses.filter(e => {
      const d = new Date(e.date);
      return d >= cycleStart && d < cycleEnd;
    });

    const targetExpense = filteredExpenses[filteredExpenses.length - 1 - indexToDelete];
    const updatedExpenses = expenses.filter(e => e !== targetExpense);

    localStorage.setItem("expenses", JSON.stringify(updatedExpenses));
    indexToDelete = null;
    document.getElementById("deleteModal").classList.remove("show");
    loadExpenses();
  }

  document.getElementById("prevMonth").addEventListener("click", () => {
    cycleOffset--;
    updateMonthDisplay();
    loadExpenses();
  });

  document.getElementById("nextMonth").addEventListener("click", () => {
    cycleOffset++;
    updateMonthDisplay();
    loadExpenses();
  });

  document.getElementById("viewMoreBtn").addEventListener("click", () => {
    showingAll = !showingAll;
    loadExpenses();
  });

  window.addEventListener("DOMContentLoaded", () => {
    updateMonthDisplay();
    loadExpenses();
  });

  fetch("nav.html")
    .then(response => response.text())
    .then(data => {
      document.getElementById("bottom-nav").innerHTML = data;

      const currentPage = window.location.pathname.split("/").pop();
      const navItems = document.querySelectorAll(".nav-item");
      navItems.forEach(item => {
        const href = item.getAttribute("href");
        if (href === currentPage) {
          item.classList.add("active");
        } else {
          item.classList.remove("active");
        }
      });
    })
    .catch(error => console.error("Error loading bottom-nav.", error));
</script>
</body>
</html>
